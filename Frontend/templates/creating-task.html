{% extends "base.html" %}

{% block extra_css %}
    <link rel="stylesheet" href="/static/css/creating-task.css">
{% endblock %}

{% block extra_script %}
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.1/dist/js.cookie.min.js"></script>
{% endblock %}

{% block content %}
    <h1>Создание задачи</h1>

    <div class="load-data-section">
        <button type="button" class="load-db-button" id="load-db-data">Загрузить данные из БД</button>
        <span id="load-status"></span>
    </div>

    <div class="types">
        <form class="container">
            <h2>Типы грузов</h2>
            <div id="container-cargo-type">
                <div class="form form-cargo-type" id="form-cargo-type-0">
                    <input type="text" placeholder="Наименование груза" class="cargo-name-input" list="cargo-types-list">
                    <datalist id="cargo-types-list"></datalist>
                    <input type="text" placeholder="Вес/кг (за ед.)" class="cargo-weight-input">
                    <button type="button" class="bin remove-form-cargo-type"></button>
                </div>
            </div>
            <button type="button" class="add-form-button" id="add-form-cargo-type">Добавить еще</button>
        </form>
        
        <form class="container">
            <h2>Типы машин</h2>
            <div id="container-truck-type">
                <div class="truck-input-row">
                    <input type="text" placeholder="Наименование" class="${nameInputClass}" list="${datalistId}" value="${nameValue}">
                    <datalist id="${datalistId}"></datalist>
                    <input type="text" placeholder="${fillingLable}" class="${fillingInputClass}" value="${fillingValue}">
                    <button type="button" class="bin remove-${formClass}"></button>
                </div>
                <div class="truck-input-row">
                    <input type="text" placeholder="Средний расход топлива на 100 км" class="truck-fuel-input" value="${fuelValue}">
                </div>
            </div>
            <button type="button" class="add-form-button" id="add-form-truck-type">Добавить еще</button>
        </form>
    </div>

    <div class="types">
        <form class="container">
            <h2>Склады/отправка</h2>
            <div id="container-warehouse">
                <div class="warehouse-form" id="warehouse-form-0">
                    <div class="form form-place">
                        <input type="text" placeholder="Название" class="warehouse-name-input" list="warehouses-list">
                        <datalist id="warehouses-list"></datalist>
                        <input type="text" placeholder="Адрес" title="Формат ввода: 'город, улица, дом'" class="warehouse-address-input">
                    </div>
                    <div class="cargo-list">
                        <div class="cargo-item">
                            <div class="cargo-item-specification">
                                <input type="text" placeholder="Тип груза" class="cargo-type-input" list="warehouse-cargos-list">
                                <datalist class="warehouse-cargos-list"></datalist>
                                <input type="text" placeholder="Количество" class="cargo-quantity-input">
                                <span class="available-quantity" style="display: none;"></span>
                            </div>
                            <div class="cargo-item-buttons">
                                <button type="button" class="add-cargo">Добавить груз</button>
                                <button type="button" class="remove-cargo">Удалить груз</button>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="remove-warehouse">Удалить склад</button>
                </div>
            </div>
            <button type="button" class="add-form-button" id="add-warehouse">Добавить еще</button>
        </form>
        
        <form class="container">
            <h2>Пункты приема</h2>
            <div id="container-destination">
                <div class="destination-form" id="destination-form-0">
                    <div class="form form-place">
                         <input type="text" placeholder="Название" class="destination-name-input" list="destinations-list">
                            <datalist id="destinations-list"></datalist>
                        <input type="text" placeholder="Адрес" title="Формат ввода: 'город, улица, дом'" class="destination-address-input">
                    </div>
                    <div class="cargo-list">
                        <div class="cargo-item">
                            <div class="cargo-item-specification">
                                <input type="text" placeholder="Тип груза" class="cargo-type-input" list="cargo-types-list">
                                <datalist id="cargo-types-list"></datalist>
                                <input type="text" placeholder="Количество" class="cargo-quantity-input">
                            </div>
                            <div class="cargo-item-buttons">
                                <button type="button" class="add-cargo">Добавить груз</button>
                                <button type="button" class="remove-cargo">Удалить груз</button>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="remove-destination">Удалить пункт</button>
                </div>
            </div>
            <button type="button" class="add-form-button" id="add-destination">Добавить еще</button>
        </form>
    </div>
    <div class="types" id="extra-costs-section" style="display: none;">
    <form class="container">
        <h2>Дополнительные расходы</h2>
        <div id="container-extra-costs">
            <div class="extra-cost-form" id="extra-cost-form-0">
                <div class="form">
                    <input type="text" placeholder="Название" class="extra-cost-name-input">
                    <input type="text" placeholder="Стоимость" class="extra-cost-value-input">
                    <button type="button" class="bin remove-extra-cost"></button>
                </div>
            </div>
        </div>
        <button type="button" class="add-form-button" id="add-extra-cost">Добавить еще</button>
    </form>
</div>


    <div>
        <button type="submit" class="clear-button">Очистить формы</button>
        <button type="submit" class="check-button">Проверить условие</button>
    </div>
{% endblock %}

{% block extra_js %}
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const settings = JSON.parse(localStorage.getItem('routeSettings')) || {};

        const isSimpleRoute = settings.routeType === 'simple';
        const considerCapacity = !isSimpleRoute && settings.considerCapacity;
        const considerFuel = !isSimpleRoute && settings.considerFuel;
        const considerExtraCosts = !isSimpleRoute && settings.considerExtraCosts;

        // Скрыть секцию машин полностью, если не учитывать вместимость
        const truckForm = Array.from(document.querySelectorAll('form.container')).find(form =>
            form.querySelector('h2')?.textContent?.includes('Типы машин')
        );
        if (!considerCapacity && truckForm) {
            truckForm.style.display = 'none';
        }

        // Если учитывать вместимость, но не учитывать топливо — удалить строку с input расхода топлива
        if (considerCapacity && !considerFuel) {
            document.querySelectorAll('.truck-fuel-input').forEach(input => {
                const fuelRow = input.closest('.truck-input-row');
                if (fuelRow) fuelRow.remove();
            });
        }

        // Показать блок дополнительных расходов, если включено
        const extraCostsSection = document.getElementById('extra-costs-section');
        if (considerExtraCosts && extraCostsSection) {
            extraCostsSection.style.display = 'block';
        }

        // Добавление доп. расходов
        document.getElementById('add-extra-cost')?.addEventListener('click', () => {
            const container = document.getElementById('container-extra-costs');
            const count = container.children.length;

            const newForm = document.createElement('div');
            newForm.className = 'extra-cost-form';
            newForm.id = `extra-cost-form-${count}`;
            newForm.innerHTML = `
                <div class="form">
                    <input type="text" placeholder="Название" class="extra-cost-name-input">
                    <input type="text" placeholder="Стоимость" class="extra-cost-value-input">
                    <button type="button" class="bin remove-extra-cost"></button>
                </div>`;
            container.appendChild(newForm);

            newForm.querySelector('.remove-extra-cost').addEventListener('click', function() {
                container.removeChild(newForm);
                saveFormDataToCookies();
            });
            
            const inputs = newForm.querySelectorAll('input');
            inputs.forEach(input => {
                input.addEventListener('input', saveFormDataToCookies);
            });
            
            saveFormDataToCookies();
        });

        // Удаление доп. расходов
        document.addEventListener('click', function (e) {
            if (e.target.classList.contains('remove-extra-cost')) {
                e.target.closest('.extra-cost-form').remove();
            }
        });
    });

        
        // Глобальные переменные для хранения данных из БД
        let dbData = {
            cargoTypes: [],
            truckTypes: [],
            warehouses: [],
            destinations: []
        };

        // Функции для работы с cookies
        function saveFormDataToCookies() {
            const formData = collectFormData();
            Cookies.set('formData', JSON.stringify(formData), { expires: 1 }); // Сохраняем на 1 день
        }

        function loadFormDataFromCookies() {
            const savedData = Cookies.get('formData');
            if (savedData) {
                return JSON.parse(savedData);
            }
            return null;
        }

        // Функции для обновления списков автозаполнения
        function updateCargoTypesList() {
            const cargoTypesLists = document.querySelectorAll('#cargo-types-list');
            
            // Обновляем основной список типов грузов (из БД или пользовательских)
            cargoTypesLists.forEach(list => {
                list.innerHTML = '';
                
                // Если есть данные из БД, используем их
                if (dbData.cargoTypes.length > 0) {
                    dbData.cargoTypes.forEach(type => {
                        const option = document.createElement('option');
                        option.value = type.name;
                        option.dataset.weight = type.weight;
                        list.appendChild(option);
                    });
                } else {
                    // Иначе собираем типы грузов из форм
                    const userCargoTypes = new Set();
                    document.querySelectorAll('.cargo-name-input').forEach(input => {
                        if (input.value.trim()) userCargoTypes.add(input.value.trim());
                    });
                    
                    userCargoTypes.forEach(type => {
                        const option = document.createElement('option');
                        option.value = type;
                        list.appendChild(option);
                    });
                }
            });

            // Обновляем списки грузов в формах складов и пунктов назначения
            updateAllWarehouseCargosLists();
            updateAllDestinationCargosLists();
        }

        function updateAllWarehouseCargosLists() {
            document.querySelectorAll('.warehouse-form').forEach(warehouseForm => {
                const warehouseNameInput = warehouseForm.querySelector('.warehouse-name-input');
                if (warehouseNameInput && warehouseNameInput.value) {
                    // Если склад выбран из БД, обновляем его грузы
                    updateWarehouseCargosList(warehouseNameInput.value, warehouseForm);
                } else {
                    // Иначе обновляем из пользовательских типов грузов
                    updateFormCargosList(warehouseForm);
                }
            });
        }

        function updateAllDestinationCargosLists() {
            document.querySelectorAll('.destination-form').forEach(destinationForm => {
                updateFormCargosList(destinationForm);
            });
        }

        function updateTruckTypesList() {
            const truckTypesList = document.getElementById('truck-types-list');
            if (!truckTypesList) return;
            
            truckTypesList.innerHTML = '';
            dbData.truckTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type.name;
                option.dataset.capacity = type.capacity;
                option.dataset.fuel = type.fuel;
                truckTypesList.appendChild(option);
            });
        }

        function updateWarehousesList() {
            const warehousesList = document.getElementById('warehouses-list');
            if (!warehousesList) return;
            
            warehousesList.innerHTML = '';
            dbData.warehouses.forEach(warehouse => {
                const option = document.createElement('option');
                option.value = warehouse.name;
                option.dataset.address = warehouse.address;
                option.dataset.cargos = JSON.stringify(warehouse.cargos);
                warehousesList.appendChild(option);
            });
        }

        function updateWarehouseCargosList(warehouseName, warehouseForm) {
            const datalists = warehouseForm.querySelectorAll('.warehouse-cargos-list');
            
            // Проверяем, есть ли этот склад в данных БД
            const warehouse = dbData.warehouses.find(w => w.name === warehouseName);
            
            if (warehouse) {
                // Если склад из БД - обновляем из данных БД с количеством
                datalists.forEach(datalist => {
                    datalist.innerHTML = '';
                    warehouse.cargos.forEach(cargo => {
                        const option = document.createElement('option');
                        option.value = cargo.type;
                        option.dataset.quantity = cargo.quantity; // Добавляем количество только для данных из БД
                        datalist.appendChild(option);
                    });
                });
            } else {
                // Если склад не из БД - обновляем из пользовательских типов без количества
                updateFormCargosList(warehouseForm);
            }
        }

        function updateFormCargosList(form) {
            const datalists = form.querySelectorAll('.warehouse-cargos-list, #cargo-types-list');
            
            datalists.forEach(datalist => {
                // Сохраняем текущее выбранное значение (если есть)
                const associatedInput = document.querySelector(`input[list="${datalist.id}"]`);
                const currentValue = associatedInput ? associatedInput.value : '';
                
                datalist.innerHTML = '';
                
                // Собираем все типы грузов из форм и БД
                const allCargoTypes = new Set();
                
                // Добавляем типы из БД
                if (dbData.cargoTypes.length > 0) {
                    dbData.cargoTypes.forEach(type => {
                        allCargoTypes.add(type.name);
                        const option = document.createElement('option');
                        option.value = type.name;
                        option.dataset.weight = type.weight;
                        datalist.appendChild(option);
                    });
                }
                
                // Добавляем пользовательские типы грузов
                document.querySelectorAll('.cargo-name-input').forEach(input => {
                    if (input.value.trim() && !allCargoTypes.has(input.value.trim())) {
                        allCargoTypes.add(input.value.trim());
                        const option = document.createElement('option');
                        option.value = input.value.trim();
                        datalist.appendChild(option);
                    }
                });
                
                // Восстанавливаем выбранное значение
                if (associatedInput && currentValue) {
                    associatedInput.value = currentValue;
                }
            });
        }

        function updateDestinationsList() {
            const destinationsList = document.getElementById('destinations-list');
            if (!destinationsList) return;
            
            destinationsList.innerHTML = '';
            console.log(dbData.destinations)
            dbData.destinations.forEach(destination => {
                const option = document.createElement('option');
                option.value = destination.name;
                option.dataset.address = destination.address;
                option.dataset.cargos = JSON.stringify(destination.cargos);
                destinationsList.appendChild(option);
            });
        }

        // Обработчики событий для автоматического заполнения полей
        function handleCargoTypeSelection(input) {
            const weightInput = input.closest('.form-cargo-type').querySelector('.cargo-weight-input');
            const selectedOption = document.querySelector(`#cargo-types-list option[value="${input.value}"]`);
            
            if (selectedOption) {
                weightInput.value = selectedOption.dataset.weight || '';
            } else {
                weightInput.value = '';
            }
        }

        function handleTruckTypeSelection(input) {
            const capacityInput = input.closest('.form-truck-type').querySelector('.truck-capacity-input');
            const fuelInput = input.closest('.form-truck-type').querySelector('.truck-fuel-input');
            const selectedOption = document.querySelector(`#truck-types-list option[value="${input.value}"]`);
            
            if (selectedOption) {
                capacityInput.value = selectedOption.dataset.capacity || '';
                fuelInput.value = selectedOption.dataset.fuel || '';
            } else {
                capacityInput.value = '';
            }
        }

        function handleWarehouseSelection(input) {
            const warehouseForm = input.closest('.warehouse-form');
            const addressInput = warehouseForm.querySelector('.warehouse-address-input');
            const selectedOption = document.querySelector(`#warehouses-list option[value="${input.value}"]`);
            
            if (selectedOption) {
                addressInput.value = selectedOption.dataset.address || '';
                updateWarehouseCargosList(input.value, warehouseForm);
            } else {
                addressInput.value = '';
                // Обновляем списки грузов из пользовательских типов
                updateFormCargosList(warehouseForm);
            }
        }

        function handleWarehouseCargoSelection(input) {
            const quantitySpan = input.closest('.cargo-item-specification').querySelector('.available-quantity');
            const warehouseForm = input.closest('.warehouse-form');
            const datalist = input.closest('.cargo-item-specification').querySelector('.warehouse-cargos-list');
            
            if (!datalist) return;
            
            const selectedOption = Array.from(datalist.options).find(option => option.value === input.value);
            
            // Проверяем, есть ли данные о доступном количестве (только для данных из БД)
            if (selectedOption && selectedOption.dataset.quantity !== undefined) {
                quantitySpan.textContent = `(Доступно: ${selectedOption.dataset.quantity})`;
                quantitySpan.style.display = 'inline';
            } else {
                quantitySpan.style.display = 'none';
            }
        }

        function handleDestinationSelection(input) {
            const destinationForm = input.closest('.destination-form');
            const addressInput = destinationForm.querySelector('.destination-address-input');
            const selectedOption = document.querySelector(`#destinations-list option[value="${input.value}"]`);
            
            if (selectedOption) {
                addressInput.value = selectedOption.dataset.address || '';
            } else {
                addressInput.value = '';
                updateFormCargosList(destinationForm);
            }
            
            updateCargoTypesList();
        }

        // Функция для загрузки данных из БД
        async function loadDataFromDatabase() {
            const statusElement = document.getElementById('load-status');
            statusElement.textContent = 'Загрузка данных...';
            statusElement.style.color = 'blue';
            
            try {
                const response = await axios.get('/get_db_data');
                if (response.data) {
                    dbData = {
                        cargoTypes: response.data.cargoTypes || [],
                        truckTypes: response.data.truckTypes || [],
                        warehouses: response.data.warehouses || [],
                        destinations: response.data.destinations || []
                    };

                    console.log(dbData)
                    
                    // Обновляем все списки
                    updateCargoTypesList();
                    updateTruckTypesList();
                    updateWarehousesList();
                    updateDestinationsList();
                    
                    statusElement.textContent = 'Данные успешно загружены';
                    statusElement.style.color = 'green';

                    if (dbData.cargoTypes.length == 0 && dbData.truckTypes.length == 0 && dbData.warehouses.length == 0 && dbData.destinations.length == 0) {
                        statusElement.textContent = 'Данные в БД отсутствуют';
                        statusElement.style.color = '#3b82f6';
                    }
                    
                    Cookies.set('dbData', JSON.stringify(dbData), { expires: 1 });
                } else {
                    throw new Error('Нет данных в ответе');
                }
            } catch (error) {
                console.error('Ошибка загрузки данных:', error);
                statusElement.textContent = 'Ошибка загрузки данных';
                statusElement.style.color = 'red';

                if (error.response && error.response.data && error.response.data.message) {
                    alert(`Ошибка: ${error.response.data.message}`);
                } else {
                    alert('Не удалось загрузить данные из БД. Проверьте подключение и попробуйте снова.');
                }
            }
        }

        function checkCargoQuantity(input) {
            const quantityInput = input;
            const cargoTypeInput = input.closest('.cargo-item-specification').querySelector('.cargo-type-input');
            const availableSpan = input.closest('.cargo-item-specification').querySelector('.available-quantity');
            
            if (!cargoTypeInput.value || !availableSpan.textContent) return true;
            
            const requestedQuantity = parseFloat(quantityInput.value) || 0;
            const availableText = availableSpan.textContent.match(/Доступно: (\d+)/);
            
            if (!availableText) return true;
            
            const availableQuantity = parseFloat(availableText[1]);
            
            if (requestedQuantity > availableQuantity) {
                quantityInput.style.borderColor = 'red';
                availableSpan.style.color = 'red';
                return false;
            } else {
                quantityInput.style.borderColor = '';
                availableSpan.style.color = '';
                return true;
            }
        }

        // Функции для создания динамических форм
        function createLittleDynamicForm(containerId, formClass, addButtonId, fillingLable, initialData = []) {
            const container = document.getElementById(containerId);
            const addButton = document.getElementById(addButtonId);
            let formCount = initialData.length || 1;

            container.innerHTML = '';

            if (initialData.length > 0) {
                initialData.forEach((data, index) => {
                    if (formClass === 'form-truck-type') {
                        addNewForm(container, formClass, index, data.name, data.capacity, data.fuel, fillingLable);
                    } else {
                        addNewForm(container, formClass, index, data.name, data.weight || data.capacity, fillingLable);
                    }
                });
            } else {
                addNewForm(container, formClass, 0, '', '', '', fillingLable);
            }

            addButton.addEventListener('click', () => {
                addNewForm(container, formClass, formCount, '', '', '', fillingLable);
                formCount++;
                saveFormDataToCookies();
            });

        function addNewForm(container, formClass, index, nameValue, fillingValue, fuelValue, fillingLable) {
            const newForm = document.createElement('div');
            newForm.classList.add('form', formClass);
            newForm.id = `${formClass}-${index}`;

            const isCargoType = formClass === 'form-cargo-type';
            const nameInputClass = isCargoType ? 'cargo-name-input' : 'truck-name-input';
            const fillingInputClass = isCargoType ? 'cargo-weight-input' : 'truck-capacity-input';
            const datalistId = isCargoType ? 'cargo-types-list' : 'truck-types-list';

            // Получаем настройки из localStorage
            const settings = JSON.parse(localStorage.getItem('routeSettings')) || {};
            const isSimpleRoute = settings.routeType === 'simple';
            const considerCapacity = !isSimpleRoute && settings.considerCapacity;
            const considerFuel = !isSimpleRoute && settings.considerFuel;

            if (isCargoType) {
                newForm.innerHTML = `
                    <input type="text" placeholder="Наименование" class="${nameInputClass}" list="${datalistId}" value="${nameValue}">
                    <datalist id="${datalistId}"></datalist>
                    <input type="text" placeholder="${fillingLable}" class="${fillingInputClass}" value="${fillingValue}">
                    <button type="button" class="bin remove-${formClass}"></button>
                `;
            } else {
                let formHTML = `
                    <div class="truck-input-row">
                        <input type="text" placeholder="Наименование" class="${nameInputClass}" list="${datalistId}" value="${nameValue}">
                        <datalist id="${datalistId}"></datalist>
                        <input type="text" placeholder="${fillingLable}" class="${fillingInputClass}" value="${fillingValue}">
                        <button type="button" class="bin remove-${formClass}"></button>
                    </div>
                `;

                if (considerFuel) {
                    formHTML += `
                        <div class="truck-input-row">
                            <input type="text" placeholder="Средний расход топлива на 100 км" class="truck-fuel-input" value="${fuelValue}">
                        </div>
                    `;
                }

                newForm.innerHTML = formHTML;
            }
                container.appendChild(newForm);

                const removeButton = newForm.querySelector(`.remove-${formClass}`);
                removeButton.addEventListener('click', () => {
                    container.removeChild(newForm);
                    if (isCargoType) {
                        updateCargoTypesList();
                    }
                    saveFormDataToCookies();
                });
                
                const nameInput = newForm.querySelector(`.${nameInputClass}`);
                nameInput.addEventListener('input', () => {
                    if (isCargoType) {
                        updateCargoTypesList();
                    }
                    saveFormDataToCookies();
                });

                if (isCargoType) {
                    nameInput.addEventListener('change', function() {
                        handleCargoTypeSelection(this);
                    });
                } else {
                    nameInput.addEventListener('change', function() {
                        handleTruckTypeSelection(this);
                    });
                }

                const inputs = newForm.querySelectorAll('input');
                inputs.forEach(input => {
                    input.addEventListener('input', saveFormDataToCookies);
                });
            }
        }

        function createBigDynamicForm(containerId, addButtonId, type, initialData = []) {
            const container = document.getElementById(containerId);
            const addButton = document.getElementById(addButtonId);
            let formCount = initialData.length || 1;

            container.innerHTML = '';

            if (initialData.length > 0) {
                initialData.forEach((data, index) => {
                    addNewForm(container, type, index, data.name, data.address, data.cargos || []);
                });
            } else {
                addNewForm(container, type, 0, '', '', []);
            }

            addButton.addEventListener('click', () => {
                addNewForm(container, type, formCount, '', '', []);
                formCount++;
                saveFormDataToCookies();
            });

            function addNewForm(container, type, index, nameValue, addressValue, cargosData) {
                const newForm = document.createElement('div');
                newForm.classList.add(`${type}-form`);
                newForm.id = `${type}-form-${index}`;
                
                let cargosHTML = '';
                if (cargosData && cargosData.length > 0) {
                    cargosData.forEach((cargo, cargoIndex) => {
                        cargosHTML += `
                            <div class="cargo-item">
                            <div class="cargo-item-specification">
                                <input type="text" placeholder="Тип груза" class="cargo-type-input" 
                                    list="warehouse-${index}-cargos-${cargoIndex}"
                                    value="${cargo.type || ''}">
                                <datalist class="warehouse-cargos-list" id="warehouse-${index}-cargos-${cargoIndex}"></datalist>
                                <input type="text" placeholder="Количество" class="cargo-quantity-input" 
                                    value="${cargo.quantity || ''}">
                                ${type === 'warehouse' ? '<span class="available-quantity" style="display: none;"></span>' : ''}
                            </div>
                            <div class="cargo-item-buttons">
                                <button type="button" class="add-cargo">Добавить груз</button>
                                <button type="button" class="remove-cargo">Удалить груз</button>
                            </div>
                        </div>
                    `;
                });
                } else {
                    cargosHTML = `
                        <div class="cargo-item">
                            <div class="cargo-item-specification">
                                <input type="text" placeholder="Тип груза" class="cargo-type-input" 
                                    list="warehouse-${index}-cargos-0">
                                <datalist class="warehouse-cargos-list" id="warehouse-${index}-cargos-0"></datalist>
                                <input type="text" placeholder="Количество" class="cargo-quantity-input">
                                ${type === 'warehouse' ? '<span class="available-quantity" style="display: none;"></span>' : ''}
                            </div>
                            <div class="cargo-item-buttons">
                                <button type="button" class="add-cargo">Добавить груз</button>
                                <button type="button" class="remove-cargo">Удалить груз</button>
                            </div>
                        </div>
                    `;
                }
                                          
                newForm.innerHTML = `
                    <div class="form form-place">
                        <input type="text" placeholder="Название" class="${type}-name-input" 
                            list="${type === 'warehouse' ? 'warehouses-list' : 'destinations-list'}" 
                            value="${nameValue || ''}">
                        ${type === 'warehouse' ? '<datalist id="warehouses-list"></datalist>' : '<datalist id="destinations-list"></datalist>'}
                        <input type="text" placeholder="Адрес" title="Формат ввода: 'город, улица, дом'" 
                            class="${type}-address-input" value="${addressValue || ''}">
                    </div>
                    <div class="cargo-list">
                        ${cargosHTML}
                    </div>
                    <button type="button" class="remove-${type}">Удалить ${type === 'warehouse' ? 'склад' : 'пункт'}</button>
                `;
                container.appendChild(newForm);

                setTimeout(() => {
                    if (type === 'warehouse') {
                        const warehouseNameInput = newForm.querySelector('.warehouse-name-input');
                        if (warehouseNameInput.value) {
                            updateWarehouseCargosList(warehouseNameInput.value, newForm);
                        } else {
                            updateFormCargosList(newForm);
                        }
                    } else {
                        updateFormCargosList(newForm);
                    }
                }, 0);

                // Добавляем обработчики
                const addCargoButtons = newForm.querySelectorAll('.add-cargo');
                const removeCargoButtons = newForm.querySelectorAll('.remove-cargo');

                addCargoButtons.forEach(btn => {
                    btn.addEventListener('click', addCargoItem);
                });

                removeCargoButtons.forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        removeCargoItem(e.target); // Передаем сам элемент кнопки, а не событие
                    });
                });

                const removeButton = newForm.querySelector(`.remove-${type}`);
                removeButton.addEventListener('click', () => {
                    container.removeChild(newForm);
                    saveFormDataToCookies();
                    // При удалении формы обновляем списки грузов
                    if (type === 'warehouse') {
                        updateAllWarehouseCargosLists();
                    } else {
                        updateAllDestinationCargosLists();
                    }
                });

                if (type === 'destination') {
                    const nameInput = newForm.querySelector('.destination-name-input');
                    nameInput.addEventListener('change', function() {
                        handleDestinationSelection(this);
                    });
                }

                if (type === 'warehouse') {
                    const nameInput = newForm.querySelector('.warehouse-name-input');
                    nameInput.addEventListener('change', function() {
                        handleWarehouseSelection(this);
                        // При изменении склада обновляем списки грузов
                        updateAllWarehouseCargosLists();
                    });
                    
                    const cargoTypeInputs = newForm.querySelectorAll('.cargo-type-input');
                    cargoTypeInputs.forEach(input => {
                        input.addEventListener('change', function() {
                            handleWarehouseCargoSelection(this);
                        });
                    });
                } else {
                    const cargoTypeInputs = newForm.querySelectorAll('.cargo-type-input');
                    cargoTypeInputs.forEach(input => {
                        input.addEventListener('change', function() {
                            // Для пунктов назначения просто обновляем списки
                            updateFormCargosList(this.closest('.destination-form'));
                        });
                    });
                }

                const inputs = newForm.querySelectorAll('input');
                inputs.forEach(input => {
                    input.addEventListener('input', saveFormDataToCookies);
                });

                    // Обновляем списки грузов для новой формы
                    if (type === 'warehouse') {
                        updateAllWarehouseCargosLists();
                    } else {
                        updateAllDestinationCargosLists();
                    }
                }

            function addCargoItem(e) {
                // Получаем элемент, на который было нажатие (может быть либо кнопка, либо событие)
                const target = e.target || e;
                const cargoList = target.closest('.cargo-list');
                
                if (!cargoList) return;
                
                const isWarehouse = target.closest('.warehouse-form') !== null;
                const warehouseForm = target.closest('.warehouse-form');
                const warehouseIndex = warehouseForm ? warehouseForm.id.split('-')[2] : '0';
                const cargoCount = cargoList.querySelectorAll('.cargo-item').length;
                
                const newCargoItem = document.createElement('div');
                newCargoItem.classList.add('cargo-item');
                newCargoItem.innerHTML = `
                    <div class="cargo-item-specification">
                        <input type="text" placeholder="Тип груза" class="cargo-type-input" list="warehouse-${warehouseIndex}-cargos-${cargoCount}">
                        <datalist class="warehouse-cargos-list" id="warehouse-${warehouseIndex}-cargos-${cargoCount}"></datalist>
                        <input type="text" placeholder="Количество" class="cargo-quantity-input">
                        ${isWarehouse ? '<span class="available-quantity" style="display: none;"></span>' : ''}
                    </div>
                    <div class="cargo-item-buttons">
                        <button type="button" class="add-cargo">Добавить груз</button>
                        <button type="button" class="remove-cargo">Удалить груз</button>
                    </div>
                `;
                cargoList.appendChild(newCargoItem);

                // Добавляем обработчики для новых кнопок
                newCargoItem.querySelector('.add-cargo').addEventListener('click', function() {
                    addCargoItem(this);
                });

                newCargoItem.querySelector('.remove-cargo').addEventListener('click', function() {
                    removeCargoItem(this);
                });
                
                if (isWarehouse) {
                    const cargoTypeInput = newCargoItem.querySelector('.cargo-type-input');
                    cargoTypeInput.addEventListener('change', function() {
                        const warehouseForm = this.closest('.warehouse-form');
                        const warehouseNameInput = warehouseForm.querySelector('.warehouse-name-input');
                        if (warehouseNameInput.value) {
                            handleWarehouseCargoSelection(this);
                        }
                    });
                }

                // Обновляем списки грузов
                if (isWarehouse && warehouseForm) {
                    const warehouseNameInput = warehouseForm.querySelector('.warehouse-name-input');
                    if (warehouseNameInput.value) {
                        updateWarehouseCargosList(warehouseNameInput.value, warehouseForm);
                    } else {
                        updateFormCargosList(warehouseForm);
                    }
                } else {
                    updateFormCargosList(newCargoItem.closest('.destination-form'));
                }

                saveFormDataToCookies();
            }

            function removeCargoItem(button) {
                const cargoItem = button.closest('.cargo-item');
                if (!cargoItem) return;
                
                const cargoList = cargoItem.closest('.cargo-list');
                if (!cargoList) return;
                
                // Проверяем, что останется хотя бы один элемент груза
                if (cargoList.querySelectorAll('.cargo-item').length > 1) {
                    cargoList.removeChild(cargoItem);
                    saveFormDataToCookies();
                    
                    // Обновляем списки грузов после удаления
                    const form = cargoList.closest('.warehouse-form, .destination-form');
                    if (form.classList.contains('warehouse-form')) {
                        updateAllWarehouseCargosLists();
                    } else {
                        updateAllDestinationCargosLists();
                    }
                }
            }
        }

        function collectFormData() {
            // Проверяем количество грузов на складах
            let isValid = true;
            document.querySelectorAll('.warehouse-form').forEach(warehouse => {
                warehouse.querySelectorAll('.cargo-item').forEach(cargo => {
                    const quantityInput = cargo.querySelector('.cargo-quantity-input');
                    if (quantityInput && !checkCargoQuantity(quantityInput)) {
                        isValid = false;
                    }
                });
            });

            if (!isValid) {
                alert('Количество запрашиваемого груза на складах превышает доступное!');
                return null;
            }

            const formData = {
                cargo_types: Array.from(document.querySelectorAll('.form-cargo-type')).map(form => {
                    const inputs = form.querySelectorAll('input');
                    return {
                        name: inputs[0].value,
                        weight: inputs[1].value
                    };
                }),
                trucks: Array.from(document.querySelectorAll('.form-truck-type')).map(form => {
                    const inputs = form.querySelectorAll('input');
                    return {
                        name: inputs[0]?.value || '',
                        capacity: inputs[1]?.value || '',
                        fuel: inputs[2]?.value || ''  // безопасный доступ
                    };
                }),
                warehouses: Array.from(document.querySelectorAll('.warehouse-form')).map(warehouse => {
                    const inputs = warehouse.querySelectorAll('.form-place input');
                    const cargos = Array.from(warehouse.querySelectorAll('.cargo-item')).map(cargo => {
                        const cargoInputs = cargo.querySelectorAll('.cargo-item-specification input');
                        // Находим вес для этого типа груза
                        const cargoType = cargoInputs[0].value;
                        const cargoWeight = Array.from(document.querySelectorAll('.form-cargo-type')).find(form => {
                            return form.querySelector('.cargo-name-input').value === cargoType;
                        })?.querySelector('.cargo-weight-input').value || '0';
                        
                        return {
                            type: cargoType,
                            quantity: cargoInputs[1].value,
                            weight: cargoWeight
                        };
                    });
                    return {
                        name: inputs[0].value,
                        address: inputs[1].value,
                        cargos: cargos
                    };
                }),
                destinations: Array.from(document.querySelectorAll('.destination-form')).map(destination => {
                    const inputs = destination.querySelectorAll('.form-place input');
                    const cargos = Array.from(destination.querySelectorAll('.cargo-item')).map(cargo => {
                        const cargoInputs = cargo.querySelectorAll('.cargo-item-specification input');
                        // Находим вес для этого типа груза
                        const cargoType = cargoInputs[0].value;
                        const cargoWeight = Array.from(document.querySelectorAll('.form-cargo-type')).find(form => {
                            return form.querySelector('.cargo-name-input').value === cargoType;
                        })?.querySelector('.cargo-weight-input').value || '0';
                        
                        return {
                            type: cargoType,
                            quantity: cargoInputs[1].value,
                            weight: cargoWeight
                        };
                    });
                    return {
                        name: inputs[0].value,
                        address: inputs[1].value,
                        cargos: cargos
                    };
                }),
                extraCosts: Array.from(document.querySelectorAll('.extra-cost-form')).map(form => {
                    const inputs = form.querySelectorAll('input');
                    return {
                        name: inputs[0].value,
                        value: inputs[1].value
                    };
                })
            };
            return formData;
        }

        function handleRequestError(error) {
            if (error.response) {
                const { data, status } = error.response;
                console.error('Ошибка сервера:', status, data);
                alert(`Ошибка сервера (${status}): ${data.message || 'Неизвестная ошибка'}`);
            } else if (error.request) {
                console.error('Нет ответа от сервера:', error.request);
                alert('Не удалось получить ответ от сервера. Проверьте подключение к интернету.');
            } else {
                console.error('Ошибка настройки запроса:', error.message);
                alert('Ошибка при отправке формы: ' + error.message);
            }
        }

        // Инициализация страницы
        document.addEventListener('DOMContentLoaded', () => {
            // Загружаем сохраненные данные из БД, если они есть
            const savedDbData = Cookies.get('dbData');
            if (savedDbData) {
                dbData = JSON.parse(savedDbData);
                updateCargoTypesList();
                updateTruckTypesList();
                updateWarehousesList();
            }

            const savedFormData = loadFormDataFromCookies();
            
            createLittleDynamicForm(
                'container-cargo-type', 
                'form-cargo-type', 
                'add-form-cargo-type', 
                'Вес/кг (за ед.)',
                savedFormData ? savedFormData.cargo_types : []
            );
            
            createLittleDynamicForm(
                'container-truck-type', 
                'form-truck-type', 
                'add-form-truck-type', 
                'Грузоподъемность/т',
                savedFormData ? savedFormData.trucks : []
            );
            
            createBigDynamicForm(
                'container-warehouse', 
                'add-warehouse', 
                'warehouse',
                savedFormData ? savedFormData.warehouses : []
            );
            
            createBigDynamicForm(
                'container-destination', 
                'add-destination', 
                'destination',
                savedFormData ? savedFormData.destinations : []
            );

            const settings = JSON.parse(localStorage.getItem('routeSettings')) || {};
            const isSimpleRoute = settings.routeType === 'simple';
            const considerExtraCosts = !isSimpleRoute && settings.considerExtraCosts;

            if (considerExtraCosts && savedFormData?.extraCosts) {
                const container = document.getElementById('container-extra-costs');
                container.innerHTML = '';
                
                savedFormData.extraCosts.forEach((cost, index) => {
                    const newForm = document.createElement('div');
                    newForm.className = 'extra-cost-form';
                    newForm.id = `extra-cost-form-${index}`;
                    newForm.innerHTML = `
                        <div class="form">
                            <input type="text" placeholder="Название" class="extra-cost-name-input" value="${cost.name || ''}">
                            <input type="text" placeholder="Стоимость" class="extra-cost-value-input" value="${cost.value || ''}">
                            <button type="button" class="bin remove-extra-cost"></button>
                        </div>`;
                    container.appendChild(newForm);
                    
                    // Добавляем обработчик для кнопки удаления
                    newForm.querySelector('.remove-extra-cost').addEventListener('click', function() {
                        container.removeChild(newForm);
                        saveFormDataToCookies();
                    });
                    
                    // Добавляем обработчики для полей ввода
                    const inputs = newForm.querySelectorAll('input');
                    inputs.forEach(input => {
                        input.addEventListener('input', saveFormDataToCookies);
                    });
                });
            }

            setTimeout(() => {
                updateAllWarehouseCargosLists();
                updateAllDestinationCargosLists();
            }, 100);

            document.getElementById('load-db-data').addEventListener('click', loadDataFromDatabase);
            
            // Очистка форм
            document.querySelector('.clear-button').addEventListener('click', function() {
                Cookies.remove('formData');
                Cookies.remove('dbData');
                location.reload();
            });

            // Проверка условия
            document.querySelector('.check-button').addEventListener('click', async function() {
                const formData = collectFormData();
                if (!formData) return;

                 const routeSettings = JSON.parse(localStorage.getItem('routeSettings')) || {
                    routeType: 'simple',
                    considerCapacity: false,
                    considerFuel: false,
                    considerExtraCosts: false
                };
                
                try {
                    const response = await axios.post('http://localhost:5000/validate', JSON.stringify(formData), {
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        params: {
                            route_settings: JSON.stringify(routeSettings)
                        }
                    });
                    
                    if (response.data.success) {
                        window.location.href = response.data.redirect || '/index.html';
                    } else {
                        alert(`Ошибка валидации: ${response.data.message}`);
                    }
                } catch (error) {
                    handleRequestError(error);
                }
            });
        });
    </script>
{% endblock %}