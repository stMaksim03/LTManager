{% extends "base.html" %}

{% block extra_css %}
    <link rel="stylesheet" href="/static/css/creating-task.css">
{% endblock %}

{% block extra_script %}
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.1/dist/js.cookie.min.js"></script>
{% endblock %}

{% block content %}
    <h1>Создание задачи</h1>

    <div class="types">
        <form class="container">
            <h2>Типы грузов</h2>
            <div id="container-cargo-type">
                <div class="form form-cargo-type" id="form-cargo-type-0">
                    <input type="text" placeholder="Наименование груза" class="cargo-name-input">
                    <input type="text" placeholder="Вес/кг (за ед.)">
                    <button type="button" class="bin remove-form-cargo-type"></button>
                </div>
            </div>
            <button type="button" class="add-form-button" class="add-form-cargo-type" id="add-form-cargo-type">Добавить еще</button>
        </form>
        
        <form class="container">
            <h2>Типы машин</h2>
            <div id="container-truck-type">
                <div class="form form-truck-type" id="form-truck-type-0">
                    <input type="text" placeholder="Наименование">
                    <input type="text" placeholder="Грузоподъемность/т">
                    <button type="button" class="bin remove-form-truck-type"></button>
                </div>
            </div>
            <button type="button" class="add-form-button" class="add-form-truck-type" id="add-form-truck-type">Добавить еще</button>
        </form>
    </div>

    <div class="types">
        <form class="container">
            <h2>Склады/отправка</h2>
            <div id="container-warehouse">
                <div class="warehouse-form" id="warehouse-form-0">
                    <div class="form form-place">
                        <input type="text" placeholder="Название">
                        <input type="text" placeholder="Адрес" title="Формат ввода: 'город, улица, дом'">
                    </div>
                    <div class="cargo-list">
                        <div class="cargo-item">
                            <div class="cargo-item-specification">
                                <input type="text" placeholder="Тип груза" class="cargo-type-input" list="cargo-types-list">
                                <datalist id="cargo-types-list"></datalist>
                                <input type="text" placeholder="Количество">
                            </div>
                            <div class="cargo-item-buttons">
                                <button type="button" class="add-cargo">Добавить груз</button>
                                <button type="button" class="remove-cargo">Удалить груз</button>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="remove-warehouse">Удалить склад</button>
                </div>
            </div>
            <button type="button" class="add-form-button" id="add-warehouse">Добавить еще</button>
        </form>
        
        <form class="container">
            <h2>Пункты приема</h2>
            <div id="container-destination">
                <div class="destination-form" id="destination-form-0">
                    <div class="form form-place">
                        <input type="text" placeholder="Название">
                        <input type="text" placeholder="Адрес" title="Формат ввода: 'город, улица, дом'">
                    </div>
                    <div class="cargo-list">
                        <div class="cargo-item">
                            <div class="cargo-item-specification">
                                <input type="text" placeholder="Тип груза" class="cargo-type-input" list="cargo-types-list">
                                <datalist id="cargo-types-list"></datalist>
                                <input type="text" placeholder="Количество">
                            </div>
                            <div class="cargo-item-buttons">
                                <button type="button" class="add-cargo">Добавить груз</button>
                                <button type="button" class="remove-cargo">Удалить груз</button>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="remove-destination">Удалить пункт</button>
                </div>
            </div>
            <button type="button" class="add-form-button" id="add-destination">Добавить еще</button>
        </form>
    </div>

    <div>
        <button type="submit" class="clear-button">Очистить формы</button>
        <button type="submit" class="check-button">Проверить условие</button>
    </div>
{% endblock %}

{% block extra_js %}
    <script>
        // Функции для работы с cookies
        function saveFormDataToCookies() {
            const formData = collectFormData();
            Cookies.set('formData', JSON.stringify(formData), { expires: 1 }); // Сохраняем на 1 день
        }

        function loadFormDataFromCookies() {
            const savedData = Cookies.get('formData');
            if (savedData) {
                return JSON.parse(savedData);
            }
            return null;
        }

        function updateCargoTypesList() {
            const cargoNameInputs = document.querySelectorAll('.cargo-name-input');
            const cargoTypesLists = document.querySelectorAll('#cargo-types-list');
            
            const cargoTypes = new Set();
            cargoNameInputs.forEach(input => {
                if (input.value.trim() !== '') {
                    cargoTypes.add(input.value.trim());
                }
            });
            
            cargoTypesLists.forEach(list => {
                list.innerHTML = '';
                cargoTypes.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type;
                    list.appendChild(option);
                });
            });
        }

        function createLittleDynamicForm(containerId, formClass, addButtonId, fillingLable, initialData = []) {
            const container = document.getElementById(containerId);
            const addButton = document.getElementById(addButtonId);
            let formCount = initialData.length || 1;

            // Очищаем контейнер перед восстановлением данных
            container.innerHTML = '';

            // Восстанавливаем сохраненные формы или создаем начальную
            if (initialData.length > 0) {
                initialData.forEach((data, index) => {
                    const newForm = document.createElement('div');
                    newForm.classList.add('form', formClass);
                    newForm.id = `${formClass}-${index}`;
                    
                    const isCargoType = formClass === 'form-cargo-type';
                    const nameInputClass = isCargoType ? 'cargo-name-input' : '';
                    
                    newForm.innerHTML = `
                        <input type="text" placeholder="Наименование" class="${nameInputClass}" value="${data.name || ''}">
                        <input type="text" placeholder="${fillingLable}" value="${data.weight || data.capacity || ''}">
                        <button type="button" class="bin remove-${formClass}"></button>
                    `;
                    container.appendChild(newForm);

                    // Добавляем обработчики
                    const removeButton = newForm.querySelector(`.remove-${formClass}`);
                    removeButton.addEventListener('click', () => {
                        container.removeChild(newForm);
                        if (isCargoType) {
                            updateCargoTypesList();
                        }
                        saveFormDataToCookies();
                    });

                    if (isCargoType) {
                        const nameInput = newForm.querySelector('.cargo-name-input');
                        nameInput.addEventListener('input', () => {
                            updateCargoTypesList();
                            saveFormDataToCookies();
                        });
                    }

                    const inputs = newForm.querySelectorAll('input');
                    inputs.forEach(input => {
                        input.addEventListener('input', saveFormDataToCookies);
                    });
                });
            } else {
                // Создаем начальную форму, если нет сохраненных данных
                const newForm = document.createElement('div');
                newForm.classList.add('form', formClass);
                newForm.id = `${formClass}-0`;
                
                const isCargoType = formClass === 'form-cargo-type';
                const nameInputClass = isCargoType ? 'cargo-name-input' : '';
                
                newForm.innerHTML = `
                    <input type="text" placeholder="Наименование" class="${nameInputClass}">
                    <input type="text" placeholder="${fillingLable}">
                    <button type="button" class="bin remove-${formClass}"></button>
                `;
                container.appendChild(newForm);

                // Добавляем обработчики
                const removeButton = newForm.querySelector(`.remove-${formClass}`);
                removeButton.addEventListener('click', () => {
                    container.removeChild(newForm);
                    if (isCargoType) {
                        updateCargoTypesList();
                    }
                    saveFormDataToCookies();
                });

                if (isCargoType) {
                    const nameInput = newForm.querySelector('.cargo-name-input');
                    nameInput.addEventListener('input', () => {
                        updateCargoTypesList();
                        saveFormDataToCookies();
                    });
                }

                const inputs = newForm.querySelectorAll('input');
                inputs.forEach(input => {
                    input.addEventListener('input', saveFormDataToCookies);
                });
            }

            addButton.addEventListener('click', () => {
                const newForm = document.createElement('div');
                newForm.classList.add('form', formClass);
                newForm.id = `${formClass}-${formCount}`;
                
                const isCargoType = formClass === 'form-cargo-type';
                const nameInputClass = isCargoType ? 'cargo-name-input' : '';
                
                newForm.innerHTML = `
                    <input type="text" placeholder="Наименование" class="${nameInputClass}">
                    <input type="text" placeholder="${fillingLable}">
                    <button type="button" class="bin remove-${formClass}"></button>
                `;
                container.appendChild(newForm);

                // Добавляем обработчики
                const removeButton = newForm.querySelector(`.remove-${formClass}`);
                removeButton.addEventListener('click', () => {
                    container.removeChild(newForm);
                    if (isCargoType) {
                        updateCargoTypesList();
                    }
                    saveFormDataToCookies();
                });

                if (isCargoType) {
                    const nameInput = newForm.querySelector('.cargo-name-input');
                    nameInput.addEventListener('input', () => {
                        updateCargoTypesList();
                        saveFormDataToCookies();
                    });
                }

                const inputs = newForm.querySelectorAll('input');
                inputs.forEach(input => {
                    input.addEventListener('input', saveFormDataToCookies);
                });

                formCount++;
                saveFormDataToCookies();
            });
        }

        function createBigDynamicForm(containerId, addButtonId, type, initialData = []) {
            const container = document.getElementById(containerId);
            const addButton = document.getElementById(addButtonId);
            let formCount = initialData.length || 1;

            // Очищаем контейнер перед восстановлением данных
            container.innerHTML = '';

            // Восстанавливаем сохраненные формы или создаем начальную
            if (initialData.length > 0) {
                initialData.forEach((data, index) => {
                    const newForm = document.createElement('div');
                    newForm.classList.add(`${type}-form`);
                    newForm.id = `${type}-form-${index}`;
                    
                    let cargosHTML = '';
                    if (data.cargos && data.cargos.length > 0) {
                        data.cargos.forEach((cargo, cargoIndex) => {
                            cargosHTML += `
                                <div class="cargo-item">
                                    <div class="cargo-item-specification">
                                        <input type="text" placeholder="Тип груза" class="cargo-type-input" list="cargo-types-list" value="${cargo.type || ''}">
                                        <datalist id="cargo-types-list"></datalist>
                                        <input type="text" placeholder="Количество" value="${cargo.quantity || ''}">
                                    </div>
                                    <div class="cargo-item-buttons">
                                        <button type="button" class="add-cargo">Добавить груз</button>
                                        <button type="button" class="remove-cargo">Удалить груз</button>
                                    </div>
                                </div>
                            `;
                        });
                    } else {
                        cargosHTML = `
                            <div class="cargo-item">
                                <div class="cargo-item-specification">
                                    <input type="text" placeholder="Тип груза" class="cargo-type-input" list="cargo-types-list">
                                    <datalist id="cargo-types-list"></datalist>
                                    <input type="text" placeholder="Количество">
                                </div>
                                <div class="cargo-item-buttons">
                                    <button type="button" class="add-cargo">Добавить груз</button>
                                    <button type="button" class="remove-cargo">Удалить груз</button>
                                </div>
                            </div>
                        `;
                    }
                    
                    newForm.innerHTML = `
                        <div class="form form-place">
                            <input type="text" placeholder="Название" value="${data.name || ''}">
                            <input type="text" placeholder="Адрес" title="Формат ввода: 'город, улица, дом'" value="${data.address || ''}">
                        </div>
                        <div class="cargo-list">
                            ${cargosHTML}
                        </div>
                        <button type="button" class="remove-${type}">Удалить ${type === 'warehouse' ? 'склад' : 'пункт'}</button>
                    `;
                    container.appendChild(newForm);

                    // Добавляем обработчики
                    const addCargoButtons = newForm.querySelectorAll('.add-cargo');
                    const removeCargoButtons = newForm.querySelectorAll('.remove-cargo');

                    addCargoButtons.forEach(btn => {
                        btn.addEventListener('click', addCargoItem);
                    });

                    removeCargoButtons.forEach(btn => {
                        btn.addEventListener('click', removeCargoItem);
                    });

                    const removeButton = newForm.querySelector(`.remove-${type}`);
                    removeButton.addEventListener('click', () => {
                        container.removeChild(newForm);
                        saveFormDataToCookies();
                    });

                    const inputs = newForm.querySelectorAll('input');
                    inputs.forEach(input => {
                        input.addEventListener('input', saveFormDataToCookies);
                    });
                });
            } else {
                // Создаем начальную форму, если нет сохраненных данных
                const newForm = document.createElement('div');
                newForm.classList.add(`${type}-form`);
                newForm.id = `${type}-form-0`;
                newForm.innerHTML = `
                    <div class="form form-place">
                        <input type="text" placeholder="Название">
                        <input type="text" placeholder="Адрес" title="Формат ввода: 'город, улица, дом'">
                    </div>
                    <div class="cargo-list">
                        <div class="cargo-item">
                            <div class="cargo-item-specification">
                                <input type="text" placeholder="Тип груза" class="cargo-type-input" list="cargo-types-list">
                                <datalist id="cargo-types-list"></datalist>
                                <input type="text" placeholder="Количество">
                            </div>
                            <div class="cargo-item-buttons">
                                <button type="button" class="add-cargo">Добавить груз</button>
                                <button type="button" class="remove-cargo">Удалить груз</button>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="remove-${type}">Удалить ${type === 'warehouse' ? 'склад' : 'пункт'}</button>
                `;
                container.appendChild(newForm);

                // Добавляем обработчики
                const addCargoButtons = newForm.querySelectorAll('.add-cargo');
                const removeCargoButtons = newForm.querySelectorAll('.remove-cargo');

                addCargoButtons.forEach(btn => {
                    btn.addEventListener('click', addCargoItem);
                });

                removeCargoButtons.forEach(btn => {
                    btn.addEventListener('click', removeCargoItem);
                });

                const removeButton = newForm.querySelector(`.remove-${type}`);
                removeButton.addEventListener('click', () => {
                    container.removeChild(newForm);
                    saveFormDataToCookies();
                });

                const inputs = newForm.querySelectorAll('input');
                inputs.forEach(input => {
                    input.addEventListener('input', saveFormDataToCookies);
                });
            }

            addButton.addEventListener('click', () => {
                const newForm = document.createElement('div');
                newForm.classList.add(`${type}-form`);
                newForm.id = `${type}-form-${formCount}`;
                newForm.innerHTML = `
                    <div class="form form-place">
                        <input type="text" placeholder="Название">
                        <input type="text" placeholder="Адрес" title="Формат ввода: 'город, улица, дом'">
                    </div>
                    <div class="cargo-list">
                        <div class="cargo-item">
                            <div class="cargo-item-specification">
                                <input type="text" placeholder="Тип груза" class="cargo-type-input" list="cargo-types-list">
                                <datalist id="cargo-types-list"></datalist>
                                <input type="text" placeholder="Количество">
                            </div>
                            <div class="cargo-item-buttons">
                                <button type="button" class="add-cargo">Добавить груз</button>
                                <button type="button" class="remove-cargo">Удалить груз</button>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="remove-${type}">Удалить ${type === 'warehouse' ? 'склад' : 'пункт'}</button>
                `;
                container.appendChild(newForm);

                // Добавляем обработчики
                const addCargoButtons = newForm.querySelectorAll('.add-cargo');
                const removeCargoButtons = newForm.querySelectorAll('.remove-cargo');

                addCargoButtons.forEach(btn => {
                    btn.addEventListener('click', addCargoItem);
                });

                removeCargoButtons.forEach(btn => {
                    btn.addEventListener('click', removeCargoItem);
                });

                const removeButton = newForm.querySelector(`.remove-${type}`);
                removeButton.addEventListener('click', () => {
                    container.removeChild(newForm);
                    saveFormDataToCookies();
                });

                const inputs = newForm.querySelectorAll('input');
                inputs.forEach(input => {
                    input.addEventListener('input', saveFormDataToCookies);
                });

                formCount++;
                saveFormDataToCookies();
            });

            function addCargoItem(e) {
                const cargoList = e.target.closest('.cargo-list');
                const newCargoItem = document.createElement('div');
                newCargoItem.classList.add('cargo-item');
                newCargoItem.innerHTML = `
                    <div class="cargo-item-specification">
                        <input type="text" placeholder="Тип груза" class="cargo-type-input" list="cargo-types-list">
                        <datalist id="cargo-types-list"></datalist>
                        <input type="text" placeholder="Количество">
                    </div>
                    <div class="cargo-item-buttons">
                        <button type="button" class="add-cargo">Добавить груз</button>
                        <button type="button" class="remove-cargo">Удалить груз</button>
                    </div>
                `;
                cargoList.appendChild(newCargoItem);

                newCargoItem.querySelector('.add-cargo').addEventListener('click', addCargoItem);
                newCargoItem.querySelector('.remove-cargo').addEventListener('click', removeCargoItem);

                const inputs = newCargoItem.querySelectorAll('input');
                inputs.forEach(input => {
                    input.addEventListener('input', saveFormDataToCookies);
                });

                saveFormDataToCookies();
            }

            function removeCargoItem(e) {
                const cargoItem = e.target.closest('.cargo-item');
                if (cargoItem && cargoItem.parentElement.querySelectorAll('.cargo-item').length > 1) {
                    cargoItem.parentElement.removeChild(cargoItem);
                    saveFormDataToCookies();
                }
            }
        }

        function collectFormData() {
            return {
                cargo_types: Array.from(document.querySelectorAll('.form-cargo-type')).map(form => {
                    const inputs = form.querySelectorAll('input');
                    return {
                        name: inputs[0].value,
                        weight: inputs[1].value
                    };
                }),
                trucks: Array.from(document.querySelectorAll('.form-truck-type')).map(form => {
                    const inputs = form.querySelectorAll('input');
                    return {
                        name: inputs[0].value,
                        capacity: inputs[1].value
                    };
                }),
                warehouses: Array.from(document.querySelectorAll('.warehouse-form')).map(warehouse => {
                    const inputs = warehouse.querySelectorAll('.form-place input');
                    return {
                        name: inputs[0].value,
                        address: inputs[1].value,
                        cargos: Array.from(warehouse.querySelectorAll('.cargo-item')).map(cargo => {
                            const cargoInputs = cargo.querySelectorAll('.cargo-item-specification input');
                            return {
                                type: cargoInputs[0].value,
                                quantity: cargoInputs[1].value
                            };
                        })
                    };
                }),
                destinations: Array.from(document.querySelectorAll('.destination-form')).map(destination => {
                    const inputs = destination.querySelectorAll('.form-place input');
                    return {
                        name: inputs[0].value,
                        address: inputs[1].value,
                        cargos: Array.from(destination.querySelectorAll('.cargo-item')).map(cargo => {
                            const cargoInputs = cargo.querySelectorAll('.cargo-item-specification input');
                            return {
                                type: cargoInputs[0].value,
                                quantity: cargoInputs[1].value
                            };
                        })
                    };
                })
            };
        }

        function handleRequestError(error) {
            if (error.response) {
                const { data, status } = error.response;
                console.error('Ошибка сервера:', status, data);
                alert(`Ошибка сервера (${status}): ${data.message || 'Неизвестная ошибка'}`);
            } else if (error.request) {
                console.error('Нет ответа от сервера:', error.request);
                alert('Не удалось получить ответ от сервера. Проверьте подключение к интернету.');
            } else {
                console.error('Ошибка настройки запроса:', error.message);
                alert('Ошибка при отправке формы: ' + error.message);
            }
        }

        // Инициализация страницы
        document.addEventListener('DOMContentLoaded', () => {
            const savedData = loadFormDataFromCookies();
            
            createLittleDynamicForm(
                'container-cargo-type', 
                'form-cargo-type', 
                'add-form-cargo-type', 
                'Вес/кг (за ед.)',
                savedData ? savedData.cargo_types : []
            );
            
            createLittleDynamicForm(
                'container-truck-type', 
                'form-truck-type', 
                'add-form-truck-type', 
                'Грузоподъемность/т',
                savedData ? savedData.trucks : []
            );
            
            createBigDynamicForm(
                'container-warehouse', 
                'add-warehouse', 
                'warehouse',
                savedData ? savedData.warehouses : []
            );
            
            createBigDynamicForm(
                'container-destination', 
                'add-destination', 
                'destination',
                savedData ? savedData.destinations : []
            );

            updateCargoTypesList();

            // Обработчик для кнопки создания задачи
            document.querySelector('.check-button').addEventListener('click', async function() {
                const formData = collectFormData();
                
                try {
                    const response = await axios.post('http://localhost:5000/validate', JSON.stringify(formData), {
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (response.data.success) {
                        window.location.href = response.data.redirect || '/index.html';
                    } else {
                        alert(`Ошибка валидации: ${response.data.message}`);
                    }
                } catch (error) {
                    handleRequestError(error);
                }
            });
        });

        document.querySelector('.clear-button').addEventListener('click', function() {
            // Удаляем cookies
            Cookies.remove('formData');
            location.reload(); // Полностью перезагружаем страницу для сброса всех счетчиков
        });
    </script>
{% endblock %}