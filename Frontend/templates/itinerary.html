{% extends "base.html" %}

{% block extra_css %}
    <link rel="stylesheet" href="/static/css/itinerary.css">
{% endblock %}

{% block extra_script %}
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.1/dist/js.cookie.min.js"></script>
    <script src="https://api-maps.yandex.ru/2.1/?apikey=90edaf8f-93f2-46f8-b63e-29fdcd48f7e5&lang=ru_RU" type="text/javascript"></script>
{% endblock %}

{% block content %}
    <div class="route">
        <aside class="sidebar">
            <h2>Маршрут</h2>
            <ul id="trucks-list" class="list"></ul>
        </aside>

        <div class="route-content">
            <h2>Карта маршрута</h2>
            <div id="map"></div>
        </div>
    </div>

    <main class="map-container">
        <div class="statistics">
            <h2>Статистические данные</h2>
            <ul class="list">
                <li id="path-length">Длина пути: ...</li>
                <li id="warehouse-count">Количество складов: ...</li>
                <li id="destination-count">Количество пунктов приема: ...</li>
                <li id="truck-count" style="display: none;">Количество машин: ...</li>
                <li id="total-cost">Суммарные затраты на доставку: ...</li>
                <li id="extra-costs" style="display: none;">Доп. расходы: ...</li>
            </ul>
        </div>
        <div class="buttons">
            <button id="edit-button">Вернуться к редактированию</button>
            <button id="save-button">Сохранить задачу</button>
        </div>
    </main>
{% endblock %}

{% block extra_js %}
<script src="/static/js/router.js"></script>

<script>
    ymaps.ready(initMap);

    function initMap() {
        const map = new ymaps.Map('map', {
            center: [55.76, 37.64],
            zoom: 10
        });

        fetch('http://localhost:5000/data')
            .then(response => response.json())
            .then(data => {
                console.log('Полученные данные:', data);  // <-- добавил для отладки

                const warehouses = data.warehouses || [];
                const destinations = data.destinations || [];
                const trucks = data.trucks || [];
                const extraCosts = data.extraCosts || [];

                warehouses.forEach(warehouse => {
                    geocodeAddress(warehouse.address, 'Склад: ' + warehouse.name, map, 'islands#blueIcon');
                });

                destinations.forEach(destination => {
                    geocodeAddress(destination.address, 'Пункт выдачи: ' + destination.name, map, 'islands#redIcon');
                });

                updateTrucksList(trucks, warehouses, destinations);

                document.getElementById('warehouse-count').textContent = `Количество складов: ${warehouses.length}`;
                document.getElementById('destination-count').textContent = `Количество пунктов приема: ${destinations.length}`;
                document.getElementById('total-cost').textContent = `Суммарные затраты на доставку: ${calculateTotalCost(data)}`;

                let settings = {};
                try {
                    settings = JSON.parse(localStorage.getItem('routeSettings')) || {};
                } catch (e) {
                    console.warn('Не удалось прочитать настройки маршрута из localStorage', e);
                }

                if (settings.considerCapacity) {
                    const truckCountEl = document.getElementById('truck-count');
                    truckCountEl.style.display = 'list-item';

                    // Проверяем, если trucks — массив с длиной > 0
                    const truckCount = Array.isArray(trucks) ? trucks.length : 0;
                    truckCountEl.textContent = `Количество машин: ${truckCount}`;
                }

                if (settings.considerExtraCosts) {
                    const extraCostsEl = document.getElementById('extra-costs');
                    extraCostsEl.style.display = 'list-item';

                    // Проверяем что extraCosts — массив и элементы имеют поле value
                    let sumExtraCosts = 0;
                    if (data.extraCosts && Array.isArray(data.extraCosts)) {
                        sumExtraCosts = data.extraCosts.reduce((sum, item) => {
                            const val = parseFloat(item.value) || 0;
                            return sum + val;
                        }, 0);
                    }
                    
                    extraCostsEl.textContent = `Доп. расходы: ${sumExtraCosts.toLocaleString('ru-RU', { style: 'currency', currency: 'RUB' })}`;
                }
            })
        .catch(error => {
            console.error('Error fetching data:', error);
            document.getElementById('trucks-list').innerHTML = '<li>Нет данных для отображения</li>';
        });
    }

    function geocodeAddress(address, title, map, iconStyle) {
        ymaps.geocode(address, { results: 1 }).then(res => {
            const obj = res.geoObjects.get(0);
            if (obj) {
                const coords = obj.geometry.getCoordinates();
                const placemark = new ymaps.Placemark(coords, {
                    hintContent: title,
                    balloonContent: address
                }, { preset: iconStyle });

                map.geoObjects.add(placemark);

                if (map.geoObjects.getLength() === 1) {
                    map.setCenter(coords);
                }
            }
        });
    }

    function updateTrucksList(trucks, warehouses, destinations) {
        const trucksList = document.getElementById('trucks-list');
        trucksList.innerHTML = '';

        if (!trucks.length) {
            const item = document.createElement('li');
            item.className = 'truck-item';

            const warehousesList = document.createElement('ul');
            warehousesList.className = 'warehouse-list';
            warehousesList.innerHTML = '<li class="subheader">Склады:</li>';
            warehouses.forEach(w => {
                const el = document.createElement('li');
                el.textContent = `${w.name}: ${w.address}`;
                warehousesList.appendChild(el);
            });

            const destinationsList = document.createElement('ul');
            destinationsList.className = 'destination-list';
            destinationsList.innerHTML = '<li class="subheader">Пункты выдачи:</li>';
            destinations.forEach(d => {
                const el = document.createElement('li');
                el.textContent = `${d.name}: ${d.address}`;
                destinationsList.appendChild(el);
            });

            item.appendChild(warehousesList);
            item.appendChild(destinationsList);
            trucksList.appendChild(item);
        } else {
            trucks.forEach((truck, index) => {
                const truckItem = document.createElement('li');
                truckItem.className = 'truck-item';
                truckItem.innerHTML = `<div class="truck-header"><span>${truck.name}</span></div>`;

                if (index === 0) {
                    const warehousesList = document.createElement('ul');
                    warehousesList.className = 'warehouse-list';
                    warehousesList.innerHTML = '<li class="subheader">Склады:</li>';
                    warehouses.forEach(w => {
                        const el = document.createElement('li');
                        el.textContent = `${w.name}: ${w.address}`;
                        warehousesList.appendChild(el);
                    });

                    const destinationsList = document.createElement('ul');
                    destinationsList.className = 'destination-list';
                    destinationsList.innerHTML = '<li class="subheader">Пункты выдачи:</li>';
                    destinations.forEach(d => {
                        const el = document.createElement('li');
                        el.textContent = `${d.name}: ${d.address}`;
                        destinationsList.appendChild(el);
                    });

                    truckItem.appendChild(warehousesList);
                    truckItem.appendChild(destinationsList);
                }

                trucksList.appendChild(truckItem);
            });
        }
    }

    function calculateTotalCost(data) {
        // Пример расчёта суммарных затрат, если есть поле totalCost
        if (data.totalCost !== undefined) {
            if (data.extraCosts && Array.isArray(data.extraCosts)) {
                data.extraCosts.forEach(cost => {
                    const value = parseFloat(cost.value) || 0;
                    totalCost += value;
                });
            } 

            return totalCost.toLocaleString('ru-RU', { style: 'currency', currency: 'RUB' });
        } else {
            return '...';
        }
    }

    document.getElementById('edit-button').addEventListener('click', () => {
        window.location.href = "creating-task.html";
    });

    document.getElementById('save-button').addEventListener('click', () => {
        Cookies.remove('formData');
        window.location.href = "index.html";
    });
</script>

{% endblock %}