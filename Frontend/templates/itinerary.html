{% extends "base.html" %}

{% block extra_css %}
    <link rel="stylesheet" href="/static/css/itinerary.css">
{% endblock %}

{% block extra_script %}
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.1/dist/js.cookie.min.js"></script>
    <script src="https://api-maps.yandex.ru/2.1/?apikey=90edaf8f-93f2-46f8-b63e-29fdcd48f7e5&lang=ru_RU" type="text/javascript"></script>
{% endblock %}

{% block content %}
    <div class="route">
        <aside class="sidebar">
            <h2>Маршрут</h2>
            <ul id="trucks-list" class="list"></ul>
        </aside>

        <div class="route-content">
            <h2>Карта маршрута</h2>
            <div id="map"></div>
        </div>
    </div>

    <main class="map-container">
        <div class="statistics">
            <h2>Статистические данные</h2>
            <ul class="list">
                <li id="path-length">Длина пути: ...</li>
                <li id="warehouse-count">Количество складов: ...</li>
                <li id="destination-count">Количество пунктов приема: ...</li>
                <li id="truck-count" style="display: none;">Количество машин: ...</li>
                <li id="total-cost">Суммарные затраты на доставку: ...</li>
                <li id="extra-costs" style="display: none;">Доп. расходы: ...</li>
            </ul>
        </div>
        <div class="buttons">
            <button id="edit-button">Вернуться к редактированию</button>
            <button id="save-button">Сохранить задачу</button>
        </div>
    </main>
{% endblock %}

{% block extra_js %}
<script src="/static/js/router.js"></script>

<script>
    ymaps.ready(initMap);

    function initMap() {
        const map = new ymaps.Map('map', {
            center: [55.76, 37.64],
            zoom: 10
        });

        window.addEventListener('routesUpdated', (event) => {
            const resultData = event.detail;
            console.log('Received routes data from event:', resultData);
            
            // Обновляем интерфейс с новыми данными
            updateStatistics(resultData.statistics);
            displayRoutesOnMap(map, resultData.trucks);
            updateTrucksList(resultData.trucks);
            
            // Сохраняем данные в глобальное хранилище (опционально)
            fetch('http://localhost:5000/data')
                .then(response => response.json())
                .then(data => {
                    data.computed_routes = [resultData];
                });
        });
    }

    function updateStatistics(stats) {
        document.getElementById('path-length').textContent = `Длина пути: ${stats.path_length} м`;
        document.getElementById('warehouse-count').textContent = `Количество складов: ${stats.warehouses_count}`;
        document.getElementById('destination-count').textContent = `Количество пунктов приема: ${stats.destinations_count}`;
        document.getElementById('truck-count').textContent = `Количество машин: ${stats.truck_count}`;
        document.getElementById('total-cost').textContent = `Суммарные затраты на доставку: ${stats.total_cost.toLocaleString('ru-RU', { style: 'currency', currency: 'RUB' })}`;
                
        // Показываем все элементы статистики
        document.getElementById('truck-count').style.display = 'list-item';

        const extraCostsEl = document.getElementById('extra-costs');
        if (stats.extra_costs && stats.extra_costs > 0) {
            extraCostsEl.style.display = 'list-item';
            extraCostsEl.textContent = `Доп. расходы: ${stats.extra_costs.toLocaleString('ru-RU', { style: 'currency', currency: 'RUB' })}`;
        } else {
            extraCostsEl.style.display = 'none';
        }
    }

    function displayRoutesOnMap(map, trucks) {
        // Очищаем карту
        map.geoObjects.removeAll();

        // Для каждой машины добавляем свои маршруты
        trucks.forEach(truck => {
            // Добавляем склады
            truck.warehouses.forEach(warehouse => {
                addPlacemark(map, warehouse.address, `Склад (${truck.name}): ${warehouse.name}`, truck.color);
            });

            // Добавляем пункты назначения
            truck.destinations.forEach(destination => {
                addPlacemark(map, destination.address, `Пункт выдачи (${truck.name}): ${destination.name}`, 'islands#redIcon');
            });

            // Добавляем маршруты
            truck.routes.forEach(route => {
                addRoute(map, route.path, `Маршрут ${truck.name}: ${route.from} → ${route.to}`, truck.color);
            });
        });
    }

    function addPlacemark(map, address, title, iconStyle) {
        ymaps.geocode(address, { results: 1 }).then(res => {
            const obj = res.geoObjects.get(0);
            if (obj) {
                const coords = obj.geometry.getCoordinates();
                const placemark = new ymaps.Placemark(coords, {
                    hintContent: title,
                    balloonContent: address
                }, { preset: iconStyle });

                map.geoObjects.add(placemark);
            }
        });
    }

    const colorMap = {
        'islands#blueIcon': '#1e98ff',
        'islands#redIcon': '#ff0000',
        'islands#greenIcon': '#00ff00',
        'islands#yellowIcon': '#ffff00',
        'islands#violetIcon': '#ee82ee'
    };
    
    function addRoute(map, pathCoords, title, color) {
        const route = new ymaps.Polyline(pathCoords, {}, {
            strokeColor: colorMap[color] || '#000000',
            strokeWidth: 4,
            strokeOpacity: 0.7
        });

        map.geoObjects.add(route);
    }

    function updateTrucksList(trucks) {
        const trucksList = document.getElementById('trucks-list');
        trucksList.innerHTML = '';

        trucks.forEach(truck => {
            const truckItem = document.createElement('li');
            truckItem.className = 'truck-item';
            truckItem.innerHTML = `<div class="truck-header" style="color: ${getColorFromPreset(truck.color)}"><span>${truck.name}</span></div>`;

            // Добавляем склады
            const warehousesList = document.createElement('ul');
            warehousesList.className = 'warehouse-list';
            warehousesList.innerHTML = '<li class="subheader">Склады:</li>';
            truck.warehouses.forEach(w => {
                const el = document.createElement('li');
                el.textContent = `${w.name}: ${w.address.replace(/{|}|'/g, '')}`;
                warehousesList.appendChild(el);
            });

            // Добавляем пункты назначения
            const destinationsList = document.createElement('ul');
            destinationsList.className = 'destination-list';
            destinationsList.innerHTML = '<li class="subheader">Пункты выдачи:</li>';
            truck.destinations.forEach(d => {
                const el = document.createElement('li');
                el.textContent = `${d.name}: ${d.address.replace(/{|}|'/g, '')}`;
                destinationsList.appendChild(el);
            });
            
            // Добавляем маршруты
            const routesList = document.createElement('ul');
            routesList.className = 'route-list';
            routesList.innerHTML = '<li class="subheader">Маршруты:</li>';
            truck.routes.forEach(r => {
                const el = document.createElement('li');
                el.textContent = `${r.from} → ${r.to} (${r.distance_m} м)`;
                routesList.appendChild(el);
            });

            truckItem.appendChild(warehousesList);
            truckItem.appendChild(destinationsList);
            truckItem.appendChild(routesList);
            trucksList.appendChild(truckItem);
        });
    }

    function getColorFromPreset(preset) {
        const colors = {
            'blueIcon': '#1e98ff',
            'redIcon': '#ff0000',
            'greenIcon': '#00ff00',
            'yellowIcon': '#ffff00',
            'violetIcon': '#ee82ee'
        };
        return colors[preset.replace('islands#', '')] || '#000000';
    }

    document.getElementById('edit-button').addEventListener('click', () => {
        window.location.href = "creating-task.html";
    });

    document.getElementById('save-button').addEventListener('click', () => {
        Cookies.remove('formData');
        window.location.href = "index.html";
    });
</script>

{% endblock %}