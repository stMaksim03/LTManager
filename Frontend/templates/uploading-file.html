{% extends "base.html" %}

{% block extra_css %}
    <link rel="stylesheet" href="/static/css/uploading-file.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" rel="stylesheet">
{% endblock %}

{% block content %}
    <div class="upload-container">
        <h1>Прикрепить файл</h1>
        <h2>Поддерживаемые форматы: .xlsx</h2>
        
        <div class="file-input-wrapper">
            <input type="file" id="fileInput" class="file-input" accept=".xlsx">
            <label for="fileInput" id="fileInputLabel" class="file-input-label">
                <img src="/static/scr/image_import.png" alt="Загрузить файл" class="image">
                <span class="file-input-text">Выберите файл или перетащите его сюда</span>
            </label>
        </div>
        
        <div id="fileInfo" class="file-info">
            <div class="file-info-text" id="fileInfoText"></div>
            <a href="#" id="fileName" class="file-name" download></a>
            <div class="file-size" id="fileSize"></div>
        </div>

        <button id="uploadBtn" class="upload-btn" disabled>Загрузить</button>
    </div>
{% endblock %}

<!-- uploading-file.html -->
{% block extra_js %}
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.1/dist/js.cookie.min.js"></script>
    <script src="/static/js/excel.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const fileInput = document.getElementById('fileInput');
            const uploadBtn = document.getElementById('uploadBtn');
            const fileInfoText = document.getElementById('fileInfoText');
            const fileInputLabel = document.getElementById('fileInputLabel');
            const fileInfo = document.getElementById('fileInfo');
            const fileName = document.getElementById('fileName');
            const fileSize = document.getElementById('fileSize');  
            let currentFile = null;
            
            fileInput.addEventListener('change', function(e) {
                if (this.files && this.files.length > 0) {
                    const file = this.files[0];
                    
                    if (!file.name.endsWith('.xlsx')) {
                        alert('Пожалуйста, выберите файл с расширением .xlsx');
                        this.value = '';
                        return;
                    }
                    
                    uploadBtn.disabled = false;
                    
                    fileInfoText.textContent = 'Выбранный файл:';
                    fileName.textContent = file.name;
                    fileName.href = URL.createObjectURL(file);
                    fileName.download = file.name;
                    fileSize.textContent = formatFileSize(file.size);
                    fileInfo.style.display = 'block';
                };
            });

            function formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }
            
            uploadBtn.addEventListener('click', async function() {
                if (fileInput.files && fileInput.files.length > 0) {
                    try {
                        const file = fileInput.files[0];
                        fileInfoText.textContent = 'Обработка файла...';
                        
                        // Загружаем данные из Excel
                        const data = await transportData.loadFromExcel(file);
                        console.log(data)
                        
                        // Сохраняем данные и отмечаем, что переход будет с загрузки файла
                        localStorage.setItem('excelData', JSON.stringify(data));
                        localStorage.setItem('fromExcelUpload', 'true');

                        // Перенаправляем на страницу создания задачи
                        window.location.href = '/creating-task.html';
                    } catch (error) {
                        console.error('Ошибка обработки файла:', error);
                        fileInfoText.textContent = 'Ошибка обработки файла';
                        alert('Ошибка при обработке файла: ' + error.message);
                    }
                }
            });
        });
    </script>
{% endblock %}